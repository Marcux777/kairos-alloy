name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  security:
    name: Security (cargo-audit)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: RustSec Audit
        uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  supply_chain:
    name: Supply Chain (cargo-deny)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Policy check
        shell: bash
        run: cargo deny --locked check advisories bans licenses sources

  layout_guard:
    name: Layout Guard (docs + workflows)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ripgrep
        shell: bash
        run: sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Verify repository layout references
        shell: bash
        run: ./platform/ops/scripts/verify-layout.sh

  python_agents:
    name: Python Agents (tests + compile)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run agent unit tests
        shell: bash
        run: python3 -m unittest discover -s apps/agents/tests -p 'test_*.py' -v

      - name: Compile Python agent/scripts
        shell: bash
        run: |
          python3 -m py_compile \
            apps/agents/agent-drl/agent_drl.py \
            apps/agents/agent-dummy/agent_dummy.py \
            apps/agents/agent-llm/agent_llm.py \
            apps/agents/kairos-gym/kairos_gym.py \
            notebooks/_lib/cpcv.py \
            platform/ops/scripts/compare_runs.py

  test:
    name: Rust (fmt + clippy + tests)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.93.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Format (rustfmt)
        shell: bash
        run: cargo fmt --all -- --check

      - name: Lint (clippy)
        shell: bash
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Test
        shell: bash
        run: cargo test --workspace --locked

  e2e_compose_smoke:
    name: E2E Compose Smoke (db + ingest + headless)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      KAIROS_DB_USER: kairos
      KAIROS_DB_PASSWORD: ci_compose_password
      KAIROS_DB_NAME: kairos
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Docker Compose availability
        shell: bash
        run: docker compose version

      - name: Start Postgres service
        shell: bash
        run: |
          set -euo pipefail
          docker compose up -d db

      - name: Wait for Postgres health
        shell: bash
        run: |
          set -euo pipefail
          db_id="$(docker compose ps -q db)"
          if [[ -z "${db_id}" ]]; then
            echo "error: db container id not found" >&2
            docker compose ps
            exit 1
          fi

          status="starting"
          for _ in {1..60}; do
            status="$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}unknown{{end}}' "${db_id}" 2>/dev/null || true)"
            if [[ "${status}" == "healthy" ]]; then
              break
            fi
            sleep 2
          done

          if [[ "${status}" != "healthy" ]]; then
            echo "error: db did not become healthy (status=${status})" >&2
            docker compose logs db
            exit 1
          fi

      - name: Run compose smoke flow
        shell: bash
        run: |
          set -euo pipefail
          docker compose run --rm -T dev bash -lc '
            set -euo pipefail

            retry() {
              local attempts="$1"
              shift
              local try=1
              until "$@"; do
                if [[ "${try}" -ge "${attempts}" ]]; then
                  return 1
                fi
                try=$((try + 1))
                sleep 2
              done
            }

            retry 3 cargo run -p kairos-ingest -- migrate --db-url "$KAIROS_DB_URL"
            retry 3 cargo run -p kairos-ingest -- ingest-kucoin \
              --db-url "$KAIROS_DB_URL" \
              --symbol BTC-USDT \
              --market spot \
              --timeframe 1min \
              --start 2017-01-01T00:00:00Z \
              --end 2017-01-01T03:00:00Z

            cargo run -p kairos-alloy -- --headless --mode validate --config platform/ops/configs/sample.toml --strict
            cargo run -p kairos-alloy -- --headless --mode backtest --config platform/ops/configs/sample.toml

            test -f runs/btc_usdt_1min_2017_2025/summary.json
            test -f runs/btc_usdt_1min_2017_2025/trades.csv
          '

      - name: Dump compose logs on failure
        if: failure()
        shell: bash
        run: docker compose logs --no-color

      - name: Teardown compose
        if: always()
        shell: bash
        run: docker compose down -v --remove-orphans
